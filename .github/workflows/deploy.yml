name: Deploy PrestaShop to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create parameters.yml
        run: |
          mkdir -p app/config
          cat <<EOF > app/config/parameters.yml
          parameters:
              database_host: 127.0.0.1
              database_port: 3306
              database_name: vipartes_ps
              database_user: vipartes_admin
              database_password: ${{ secrets.DB_PASS }}
              database_prefix: ps_
              database_engine: InnoDB
              mailer_transport: smtp
              mailer_host: 127.0.0.1
              secret: ${{ secrets.PS_SECRET }}
              ps_caching: CacheMemcache
              ps_cache_enable: false
              ps_creation_date: '2024-01-01'
              locale: es-ES
              use_html_purifier: true
              cookie_key: ${{ secrets.PS_COOKIE_KEY }}
              cookie_iv: ${{ secrets.PS_COOKIE_IV }}
              new_cookie_key: ${{ secrets.PS_NEW_COOKIE_KEY }}
          EOF

      - name: Deploy via rsync
        uses: Burnett01/rsync-deployments@7.0.1
        with:
          switches: -avzr --delete --exclude='.git*' --exclude='var/cache/*' --exclude='vendor/*'
          path: ./
          remote_path: /var/www/vhosts/vipartesanias.ubbie.studio/httpdocs/
          remote_host: 148.251.42.8
          remote_user: ubbie_vipartesanias
          remote_key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Server Post-Deployment Tasks
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 148.251.42.8
          username: ubbie_vipartesanias
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            export PHP_BIN="/opt/plesk/php/8.2/bin/php"
            cd /var/www/vhosts/vipartesanias.ubbie.studio/httpdocs/
            
            # 1. Database
            mysql -u vipartes_admin -p'${{ secrets.DB_PASS }}' vipartes_ps -e "UPDATE ps_shop_url SET domain='vipartesanias.ubbie.studio', domain_ssl='vipartesanias.ubbie.studio', physical_uri='/'; UPDATE ps_configuration SET value='vipartesanias.ubbie.studio' WHERE name='PS_SHOP_DOMAIN' OR name='PS_SHOP_DOMAIN_SSL';"
            
            # 2. Composer
            rm -f composer.phar
            $PHP_BIN -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
            $PHP_BIN composer-setup.php
            rm composer-setup.php
            curl -L https://raw.githubusercontent.com/PrestaShop/PrestaShop/8.2.4/composer.json -o composer.json
            curl -L https://raw.githubusercontent.com/PrestaShop/PrestaShop/8.2.4/composer.lock -o composer.lock
            $PHP_BIN composer.phar install --no-dev --optimize-autoloader --no-interaction --ignore-platform-reqs

            # 3. Verify Directory Integrity (Diagnostic)
            echo "Checking for core files..."
            ls -d classes/ src/ config/ vendor/ || echo "WARNING: CORE DIRECTORIES MISSING"

            # 4. DEFINES
            cat <<'EOF' > config/defines.inc.php
            <?php
            $currentDir = dirname(__FILE__);
            define('_PS_VERSION_', '8.2.4');
            define('_PS_CONFIG_DIR_', $currentDir.'/');
            define('_PS_ROOT_DIR_', realpath($currentDir.'/..').'/');
            define('_PS_CORE_DIR_', _PS_ROOT_DIR_);
            define('_PS_VAR_DIR_', _PS_ROOT_DIR_.'var/');
            define('_PS_CACHE_DIR_', _PS_VAR_DIR_.'cache/');
            define('_PS_MODULE_DIR_', _PS_ROOT_DIR_.'modules/');
            define('_PS_TOOL_DIR_', _PS_ROOT_DIR_.'tools/');
            define('_PS_CUSTOM_CONFIG_FILE_', _PS_CONFIG_DIR_.'settings.inc.php');
            define('_PS_IMG_DIR_', _PS_ROOT_DIR_.'img/');
            define('_PS_MODE_DEV_', false);
            define('_PS_DEBUG_PROFILING_', false);
            define('_PS_DISPLAY_COMPATIBILITY_WARNING_', false);
            EOF

            # 5. HARDCODED ALIAS BRIDGE
            # If the autoloader fails, we manually point to the core files.
            cat <<'EOF' > config/autoload.php
            <?php
            require_once __DIR__ . '/../vendor/autoload.php';
            
            spl_autoload_register(function ($class) {
                $file = __DIR__ . '/../classes/' . $class . '.php';
                if (file_exists($file)) {
                    require_once $file;
                }
                // PrestaShop 8 standard
                $coreFile = __DIR__ . '/../classes/' . str_replace('Core', '', $class) . '.php';
                if (str_ends_with($class, 'Core') && file_exists($coreFile)) {
                   require_once $coreFile;
                }
            }, true, true);

            // Force Alias for Tools
            if (!class_exists('Tools')) {
                require_once __DIR__ . '/../classes/Tools.php';
                class_alias('ToolsCore', 'Tools');
            }
            EOF

            # 6. Cleanup
            mkdir -p var/cache/prod
            rm -rf var/cache/*
            chmod -R 775 var/cache
            
            # 7. VERIFICATION
            echo "Running Bootstrap Test..."
            $PHP_BIN -d display_errors=1 -r "require 'config/autoload.php'; require 'config/config.inc.php'; if(class_exists('Tools')) echo 'Full Bootstrap Success';"