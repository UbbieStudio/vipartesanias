name: Deploy PrestaShop to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Dependencies (Composer Local)
        run: composer install --no-dev --optimize-autoloader --ignore-platform-reqs

      - name: Create parameters.yml
        run: |
          echo "parameters:" > app/config/parameters.yml
          echo "    database_host: 127.0.0.1" >> app/config/parameters.yml
          echo "    database_port: 3306" >> app/config/parameters.yml
          echo "    database_name: vipartes_ps" >> app/config/parameters.yml
          echo "    database_user: vipartes_admin" >> app/config/parameters.yml
          echo "    database_password: ${{ secrets.DB_PASS }}" >> app/config/parameters.yml
          echo "    database_prefix: ps_" >> app/config/parameters.yml
          echo "    database_engine: InnoDB" >> app/config/parameters.yml
          echo "    mailer_transport: smtp" >> app/config/parameters.yml
          echo "    mailer_host: 127.0.0.1" >> app/config/parameters.yml
          echo "    secret: ${{ secrets.PS_SECRET }}" >> app/config/parameters.yml
          echo "    ps_caching: CacheMemcache" >> app/config/parameters.yml
          echo "    ps_cache_enable: false" >> app/config/parameters.yml
          echo "    ps_creation_date: '2024-01-01'" >> app/config/parameters.yml
          echo "    locale: es-ES" >> app/config/parameters.yml
          echo "    use_html_purifier: true" >> app/config/parameters.yml
          echo "    cookie_key: ${{ secrets.PS_COOKIE_KEY }}" >> app/config/parameters.yml
          echo "    cookie_iv: ${{ secrets.PS_COOKIE_IV }}" >> app/config/parameters.yml
          echo "    new_cookie_key: ${{ secrets.PS_NEW_COOKIE_KEY }}" >> app/config/parameters.yml

      - name: Prepare for Rsync
        run: rm -f .gitignore

      - name: Deploy via rsync
        uses: Burnett01/rsync-deployments@7.0.1
        with:
          # Removed --delete to ensure we don't accidentally wipe core server dirs
          switches: -avzr
          path: ./
          remote_path: /var/www/vhosts/vipartesanias.ubbie.studio/httpdocs/
          remote_host: 148.251.42.8
          remote_user: ubbie_vipartesanias
          remote_key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Server Post-Deployment Tasks
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 148.251.42.8
          username: ubbie_vipartesanias
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            export PHP_BIN="/opt/plesk/php/8.2/bin/php"
            cd /var/www/vhosts/vipartesanias.ubbie.studio/httpdocs/
            
            # 1. Clear Cache Completely
            rm -rf var/cache/*
            
            # 2. Fix Directory Permissions (Crucial for Plesk)
            find . -type d -exec chmod 755 {} +
            find . -type f -exec chmod 644 {} +
            
            # 3. Update Database
            mysql -u vipartes_admin -p'${{ secrets.DB_PASS }}' vipartes_ps -e "UPDATE ps_shop_url SET domain='vipartesanias.ubbie.studio', domain_ssl='vipartesanias.ubbie.studio', physical_uri='/'; UPDATE ps_configuration SET value='vipartesanias.ubbie.studio' WHERE name='PS_SHOP_DOMAIN' OR name='PS_SHOP_DOMAIN_SSL';"
            
            # 4. Perform a CLEAN Composer Install on the server
            $PHP_BIN -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
            $PHP_BIN composer-setup.php
            # Remove vendor and lock to force a perfectly clean state
            rm -rf vendor composer.lock
            $PHP_BIN composer.phar install --no-dev --optimize-autoloader --ignore-platform-reqs
            
            # Cleanup
            rm composer-setup.php composer.phar